**提示 1：** 我们只在乎蛇头尾的位置，查询又只能查询一个矩形区域，那么，怎么判断头尾和矩形之间的位置关系？

**提示 2：** 利用上述查询，尝试确定头尾位置。有无特殊情况？

对于第一个提示，一个点相对于一个矩形其实只有两种位置关系（没办法在边上的情况）——

- 在矩形内部

- 在矩形外部

那么头尾两个点相对于矩形，总共只有 $3$ 种情况：

- 都在矩形外部

- 都在矩形内部

- 一个在矩形外部，一个在矩形内部

那么，我们的查询能否区分这三种情况呢？事实上，我们可以区分最后一种情况。

我们查询的其实是蛇的身体穿过矩形的次数。蛇的身体可以不断穿过矩形边界，所以查询得到的具体数字并不关键。但每次 “多余” 地穿过矩形边界都会 **多造成 $2$ 次穿越次数** 。于是我们可以发现这样的结论——

- 如果查询的结果为奇数，一定一个点在矩形内，一个点在矩形外。

- 否则，要么两个点都在矩形内，要么两个点都在矩形外。

如果我们随意画一个矩形，矩形内外形式并不规整，不好进行判断。因此考虑作矩形 $(1,1)$ 到 $(n, i)$ 或 $(i, n)$ .

这样的矩形在查询中相当于给我们了一些分割线，让我们判断 **头尾是否在某条横线 / 竖线的两端** 。

如果我们找到了所有可以分割的横线和竖线，且 **两者都非空集** ，也就意味着我们找到了头尾两个点的横坐标 $x_1, x_2$ 与纵坐标 $y_1, y_2$ 。

而结果是 $(x_1, y_1),(x_2, y_2)$ 还是 $(x_2, y_1), (x_1, y_2)$ ，可以通过查询其中一个点构成的矩形进行判断。

接下来还剩下一种情况：头尾横坐标 / 纵坐标相等。

这种情况下，我们只能确定其中一个维度的坐标（这个维度下头尾坐标不同）。我们需要找到另一个维度下两个点坐标为何（这个唯独下头尾坐标相同）。

我们不妨假设确定的是横坐标 $x_1, x_2\ (x_1\lt x_2)$ ，需要找到两者的纵坐标 $y$ 。

由于我们只在乎查询结果的奇偶性，这时我们把蛇看成一条横着的线段，中间的身体没有意义。我们的目标是查询 **这条横着的线段的纵坐标** 。

我们要用比较小的次数查询出来这个 $y$ ，因此考虑使用二分。

而我们二分的判定是查询是否穿过矩形边界，因此我们构造 $(1,1)$ 出发的矩形，到 $(x_1, mid)$ ，线段是否超过矩形。

这样查询就满足二段性，在坐标够大的情况下线段能穿过矩形，否则不行。

于是我们在这种情况下也找到了两个端点。

具体查询次数，包括开始的 $999\times 2=1998$ 次枚举分割线，再加上后续二分 $\lceil\log 1000\rceil=10$ ，共计 $2008$ 次，顺利实现。

#### 具体代码如下（只包含中间处理部分）——

```Python []
def query(x1, y1, x2, y2):
    print('?', x1, y1, x2, y2, flush=True)
    return II()
 
def answer(x1, y1, x2, y2):
    print('!', x1, y1, x2, y2)
 
def main():
    n = II()
    
    xl, xr = -1, -1
    for i in range(1, n):
        if query(1, 1, i, n) % 2:
            if xl == -1: xl = i
            xr = i + 1
    
    yl, yr = -1, -1
    for i in range(1, n):
        if query(1, 1, n, i) % 2:
            if yl == -1: yl = i
            yr = i + 1
    
    if xl == -1:
        l, r = 1, n
        while l <= r:
            m = (l + r) // 2
            if query(1, yl, m, yl) % 2:
                r = m - 1
            else:
                l = m + 1
        xl = xr = l
    
    elif yl == -1:
        l, r = 1, n
        while l <= r:
            m = (l + r) // 2
            if query(xl, 1, xl, m) % 2:
                r = m - 1
            else:
                l = m + 1
        yl = yr = l
    
    if query(xl, yl, xl, yl) % 2:
        answer(xl, yl, xr, yr)
    else:
        answer(xl, yr, xr, yl)
```