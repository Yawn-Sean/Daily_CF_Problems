**提示 1：** 首先，观察本题的数据范围是 $5000$ ，只要我们可以 $\mathcal{O}(1)$ 或比较小的时间内得到子字符串是否合法的判断，则总用时是 $\mathcal{O}(n^2)$ 的，可以完成本题。

**提示 2：** 对于一个字符串，怎么判断是否可以替换 `'?'` 使得整体成为一个合法的括号序列呢？

如果没有问号，一个括号字符串是否合法怎么判断呢？

我们发现，从头遍历到尾，每次遇到前括号就 $+1$ ，否则 $-1$ ，要求最后结果为 $0$ ，且中间不经过负数。我们称之为一个前缀和。

那如果有问号怎么办呢？

我们考虑从头到尾进行遍历，**如果遇到问号先设定为右括号，如果遇到的前缀和小于 $0$ 了，再把前面还没换成左括号的右括号换成左括号** 。

这么做的话，我们可以保证我们中间经历的所有数都是非负的，同时最后的前缀和最小，而这个前缀和为 $0$ 的情况下，字符串满足要求。

但如果我们对于每个字符串都完整地进行一遍上述替代，每个字符串的判断时间是跟字符串长度成正比的，不满足本题的要求。

于是我们要用到子字符串之间的相关关系，即 **一个子字符串添加其右侧的字符会得到一个新的子字符串**。

我们仍使用前面的逻辑，在保证中间经历数值均非负的情况下，最小化我们最后的前缀和。如果该前缀和为 $0$ ，则该子字符串满足要求，则我们最终的计数结果 $+1$ 。而在这个逻辑下，我们只需要维护 **当前能达到的最小值以及可以转化的右括号的数量** 。

相比前面的过程而言，我们这里只需要说明新增字符的时候，这两个数字如何改变。我们如果遇到问号，先强行赋为右括号，接下来如果使得前缀和为负数，则尝试找到之前问号变成的右括号将其改为左括号，使得当前可达的最小值 $+2$ 不再为负数。之所以增加的数值是 $2$ ，是因为相当于从 $-1$ 变成了 $1$ 。

如果某一刻出现不可避免的负数，即前缀和已经为负，但不存在可以变成左括号的右括号，则后面的字符串不可能满足要求，直接退出循环。

总时间复杂度为 $\mathcal{O}(n^2)$ .

#### 具体代码如下（只包含中间处理部分）——

```Python []
def main():
    s = I()
    n = len(s)

    ans = 0
    for i in range(n):
        cur = 0
        right = 0
        for j in range(i, n):
            if s[j] == '(':
                cur += 1
            elif s[j] == ')':
                cur -= 1
            else:
                cur -= 1
                right += 1
            if cur < 0:
                if right == 0: break
                right -= 1
                cur += 2
            if cur == 0:
                ans += 1

    print(ans)
```
