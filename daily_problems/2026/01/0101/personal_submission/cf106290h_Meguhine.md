考虑将数组复制一份拼到后面，对于某个左端点 $l$，现在只要在 $[l,l+n-1]$ 这段上找一个分界点 $r$ 即可，此时数组被分成了**两段**

考虑 $\text{ans}=\text{base}+\text{ext}$，其中 $\text{base}$ 是数组总共有多少个不同的元素，$\text{ext}$ 是分割后在两段中都出现的元素的数量

$\text{base}$ 是常量，$O(n)$ 扫一遍统计即可

对于 $\text{ext}$，考虑对一个元素 $x$，$L(x)$ 是 $[l,l+n-1]$ 中第一个 $\ge l$ 的位置，$R(x)$ 是 $[l,l+n-1]$ 中最后一个 $\le l+n-1$ 的位置。在线段树中，把 $L(x)$ 的值设置成 1，$R(x)$ 的值设置成 $-1$，查询 $[l,l+n-1]$ 的最大前缀即可

$L(x),R(x)$ 可以通过双指针的方式来维护

总时间复杂度 $O(n\log n)$
